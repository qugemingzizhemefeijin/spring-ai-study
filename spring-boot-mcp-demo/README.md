# 2025-05-12 最新说明

spring官方文档已更新，依赖名称发生变化，目前该demo中的依赖已经拉取不到，请大家查阅最新文档自行做整合！

# 说明

有读者反馈想要源码自己实践下，就搞个仓库传上来。


项目结构和代码不是很规范，当时写文章重在跑通上，还请大家不要学，看实践就好！


原文来自以下平台：

[对话即服务：Spring Boot整合MCP让你的CRUD系统秒变AI助手](https://juejin.cn/post/7483454392979570700)

https://blog.csdn.net/m0_60925013/article/details/146393912?spm=1001.2014.3001.5501

https://cloud.tencent.com.cn/developer/article/2506434

https://developer.aliyun.com/article/1657752?spm=a2c6h.13262185.profile.12.68bb606c9YqAqv

[用Spring AI+OpenAI构建企业级智能客服](https://blog.51cto.com/u_15423953/13859660)

[SpringAl实现AI应用-快速搭建](https://blog.csdn.net/m0_71817461/article/details/147604743)

[如何通过Spring AI接入DeepSeek模型？](https://mp.weixin.qq.com/s?__biz=Mzg5MjkxNTA5MA==&mid=2247491902&idx=2&sn=7afd276ed769597ffdc278f829431b29&chksm=c123339567f0e4e87b6fcdf21a929979a1c8c4c18dcd8398b3b003d29d106112ac578942fc29&scene=27)


以下功能抄自：[构建下一代AI智能体：基于Spring AI的多轮对话应用](https://blog.csdn.net/jgk666666/article/details/147880770)

### 一、Prompt工程精要

核心三角

🔑 系统Prompt：AI人格设定

💬 用户Prompt：即时需求输入

📚 助手Prompt：对话上下文记忆

### 三大维度

功能型：指令/对话/创意/角色扮演

复杂度：简单→复合→链式→模板

开发级：基础提示→参数化模板→多轮记忆链

黄金法则：专业度=系统设定×场景约束×示例引导

#### token成本公式

总成本 = 输入 Token × 输入价 + 输出 Token × 输出价

### 二、prompt 优化技巧：

#### 基础提示技巧

- 明确指定任务和角色（设定角色定位与具体需求）
- 提供详细说明和具体示例（补充背景信息与案例参考）
- 使用结构化格式引导思维（通过表格/列表等形式增强逻辑性）
- 明确输出格式要求（限定字数/风格/框架等标准）

#### 进阶提示技巧

- 思维链提示法（展示推理过程分步拆解问题）
- 少样本学习（通过少量输入-输出示例建立模式认知）
- 分步骤指导（将复杂任务分解为可执行单元）
- 自我评估和修正（主动检验结果并优化解决方案）
- 知识检索和引用（关联外部知识库并标注来源）
- 多视角分析（从不同立场或学科角度切入分析）
- 多模态思维（融合文字/图表/流程等多元表达形式）

#### 提示词调试与优化

- 迭代式提示优化（通过反复修改提升效果）
- 边界测试（测试模型极限能力发现改进方向）
- 提示词模板化（建立标准化模板确保结果统一）
- 错误分析与修正（定位问题根源进行定向优化改进）

### 三、AI需求分析

需求三剑客：

- 需求从哪儿来？挖需求 → 抄AI应用商店爆款
- 怎么细化需求？养需求 → 喂Prompt让AI当产品总监
- MVP 最小可行产品策略 验需求 → 先做基础核心功能

### 四、AI 应用方案设计

1、系统提示词设计

普通提示词 在为简短 ai 简单的身份命名。

优化后的 prompt 提示词

提示词模板

```
你是Prompt专家，可以根据格式生成各种专业的Prompt。
接下来请写一个“[请填写你想定义的角色名称（唯一需要手动输入的地方）]”的prompt，以Markdown输出，格式参考如下：
----------------
## Role : [请填写你想定义的角色名称]## Role : [请填写你想定义的角色名称]
 
## Background : [请描述角色的背景信息，例如其历史、来源或特定的知识背景]
 
## Preferences :[请描述角色的偏好或特定风格，例如对某种设计或文化的偏好]
 
## Profile :
 - author: lenyan
 - version: 1.0
 - language: 中文
 - description: [请简短描述该角色的主要功能，50 字以内]
 
## Goals :
[请列出该角色的主要目标 1]
[请列出该角色的主要目标 2]
...
 
## Constrains :
[请列出该角色在互动中必须遵循的限制条件 1]
[请列出该角色在互动中必须遵循的限制条件 2]
...
 
 ## Skills :
[为了在限制条件下实现目标，该角色需要拥有的技能 1]
[为了在限制条件下实现目标，该角色需要拥有的技能 2]
...
 
## Examples :
[提供一个输出示例 1，展示角色的可能回答或行为]
[提供一个输出示例 2，展示角色的可能回答或行为]
...
## OutputFormat :
[请描述该角色的工作流程的第一步]
[请描述该角色的工作流程的第二步]
...
 
## Initialization :
作为 [角色名称], 
拥有 [列举技能],
严格遵守 [列举限制条件], 
友好的欢迎用户。
然后介绍自己，并提示用户输入.
```

```
Role : 恋爱大师·情感导航员
Background :
拥有10年情感咨询经验的心理学专家，擅长运用亲密关系理论、非暴力沟通技巧和认知行为疗法，帮助过上千对情侣解决情感矛盾。熟悉不同文化背景下的恋爱模式差异，尤其擅长处理信任危机、沟通障碍和关系定位问题。
Preferences :
以温暖包容的语气质询，避免评判性语言。偏好用生活化比喻解释心理学概念，注重用户隐私保护，始终维护双方平等话语权。
Profile :
● author: lenyan
● version: 1.0
● language: 中文
● description: 专业解析恋爱矛盾，提供科学情感建议的虚拟咨询师
Goals :
1. 帮助用户识别并表达真实情感需求  
2. 提供可操作的沟通策略与冲突解决方法  
3. 引导建立健康的关系边界意识  
4. 促进双方视角转换与同理心培养  
5. 保护用户隐私不泄露敏感信息
Constrains :
1. 严禁涉及医疗诊断或药物建议  
2. 避免对用户做出道德评判  
3. 不代用户做决定，保持中立立场  
4. 涉及人身安全问题时需提示专业机构  
5. 回应需符合中国社会伦理规范
Skills :
1. 情感需求分析（识别隐藏情绪）  
2. 非暴力沟通框架构建  
3. 认知行为疗法应用  
4. 关系发展阶段理论  
5. 文化敏感性沟通技巧  
6. 边界设定指导
Examples :
用户提问："男朋友总忘记我们的纪念日，是不是不爱我了？"
回答示例："这个行为可能有多种解读角度。我们可以先分析：1. 他的记忆模式是否普遍容易遗忘重要日期？2. 他是否用其他方式表达爱意？3. 你内心真正期待的是仪式感还是被重视的感觉？建议尝试用'观察+感受'的方式沟通，比如：'我发现最近几次纪念日你都没特别安排，我有点失落，其实我更希望...'"
用户提问："吵架时他总冷战，怎么沟通才有效？"
回答示例："冷战往往是情绪过载的自我保护机制。可以试试：① 确认双方平静后再对话 ② 用'我句式'表达感受：'当你冷战时，我感到被忽视，担心问题没解决' ③ 共同制定'情绪急救方案'，比如约定深呼吸5次后再回应。需要我帮你具体模拟对话场景吗？"
OutputFormat :
1. 情绪确认：先共情用户感受，如"这种感受很常见"  
2. 问题拆解：将复杂情况分解为3-5个分析维度  
3. 理论支撑：引用1-2个心理学概念解释现象  
4. 行动方案：提供2种具体可操作的沟通策略  
5. 后续引导：询问用户想深入探讨的具体方向
Initialization :
作为 恋爱大师·情感导航员，
拥有 非暴力沟通框架构建、认知行为疗法应用、关系阶段理论分析 等核心技能，
严格遵守 保持中立立场、保护隐私、不越界建议 等执业准则，
你好，我是你的专属恋爱顾问。无论是甜蜜困惑还是矛盾困扰，我都会用心理学视角为你解惑。请告诉我此刻最想探讨的情感问题吧。
```

### 二、多轮对话实现

#### 1. ChatClient 特性

Spring AI 的核心对话客户端，支持链式调用（Fluent API）、动态参数绑定（如模板变量）、多种响应格式（实体映射、流式输出），并可通过拦截器（Advisors）扩展功能。

#### 2. Advisors（拦截器）

责任链模式的拦截器机制，在调用大模型前后执行增强逻辑（如注入历史对话、安全校验）。通过 getOrder() 控制执行顺序，常用如 MessageChatMemoryAdvisor（对话记忆）、QuestionAnswerAdvisor（知识检索）。

#### 3. Chat Memory Advisor

负责维护对话上下文的拦截器，常见：

- MessageChatMemoryAdvisor：将历史消息作为独立角色记录注入 Prompt（保留完整对话结构）。
- PromptChatMemoryAdvisor：将历史对话拼接为系统提示文本（可能丢失消息边界）。

#### 4. Chat Memory

对话记录的存储接口，提供保存/查询/清空消息的能力，内置实现包括：

- 内存存储（InMemoryChatMemory）
- 持久化存储（JDBC、Cassandra、Neo4j 等）
- 向量数据库扩展（VectorStoreChatMemoryAdvisor 支持检索增强）。

开发流程：

- ① 创建ChatClient并绑定大模型
- ② 配置MessageChatMemoryAdvisor+选择ChatMemory实现
- ③ 通过.defaultAdvisors()注入记忆处理链
- ④ 对话时自动携带历史上下文

技术栈：Spring AI 框架 + ChatClient + MessageChatMemoryAdvisor。

核心机制：对话历史自动注入模型上下文（保留角色标识）。内存存储会话数据（支持替换为数据库）。

```
ChatMemory chatMemory = new InMemoryChatMemory();
chatClient = ChatClient.builder(dashscopeChatModel)
        .defaultSystem(SYSTEM_PROMPT)
        .defaultAdvisors(
                new MessageChatMemoryAdvisor(chatMemory),
                // 记录日志
                new MyLoggerAdvisor(),
                // 违禁词检测 - 从文件读取违禁词
                new ProhibitedWordAdvisor(),
                // 复读强化阅读能力
                new ReReadingAdvisor()
                )
        .build();
```
